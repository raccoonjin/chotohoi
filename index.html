<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¡±íƒ„ ê³¨í”„ ëª¨ì„</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="ë¡±íƒ„ê³¨í”„">
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1202/1202125.png">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/1202/1202125.png">

    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    
    <style>
        /* í„°ì¹˜ ë°˜ì‘ ì†ë„ ê°œì„  ë° ë“œë˜ê·¸ ë°©ì§€ */
        body { touch-action: manipulation; -webkit-tap-highlight-color: transparent; user-select: none; }
        .score-btn:active { transform: scale(0.95); }
        .bg-grass { background-color: #f0fdf4; }
        /* ìŠ¤ë¬´ìŠ¤í•œ ì• ë‹ˆë©”ì´ì…˜ */
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 300ms; }
    </style>
</head>
<body class="bg-grass h-screen flex flex-col font-sans overflow-hidden">

    <header class="bg-green-800 text-white p-4 pb-2 shadow-lg sticky top-0 z-50 pt-safe-top">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-2">
                <select id="courseSelect" onchange="changeCourse()" class="bg-green-900 text-white font-bold border border-green-600 rounded px-2 py-1 text-sm outline-none shadow-sm">
                    <option value="hill">HILL ì½”ìŠ¤</option>
                    <option value="lake">LAKE ì½”ìŠ¤</option>
                </select>
                <span id="saveStatus" class="text-xs font-bold px-2 py-1 rounded opacity-0 transition-all transform scale-90">ëŒ€ê¸°</span>
            </div>
            <span class="text-xs bg-red-600 text-white font-bold px-2 py-1 rounded animate-pulse shadow-md">LIVE ğŸ”´</span>
        </div>
        
        <div class="flex justify-between items-center bg-green-700 rounded-xl p-2 shadow-inner border border-green-600">
            <button onclick="changeHole(-1)" class="w-12 h-10 flex items-center justify-center font-bold text-2xl active:bg-green-800 rounded-lg text-green-100">â—€</button>
            <div class="text-center">
                <span class="text-2xl font-black block tracking-widest leading-none drop-shadow-md" id="currentHoleDisplay">HOLE 1</span>
                <span class="text-sm text-green-200 font-medium" id="currentParDisplay">Par 4</span>
            </div>
            <button onclick="changeHole(1)" class="w-12 h-10 flex items-center justify-center font-bold text-2xl active:bg-green-800 rounded-lg text-green-100">â–¶</button>
        </div>
    </header>

    <div class="flex bg-white border-b border-green-100 shadow-sm z-40">
        <button onclick="selectGroup(0)" id="tab-0" class="flex-1 py-3 text-center font-bold text-green-800 border-b-4 border-green-600 bg-green-50 transition-all">1ì¡°</button>
        <button onclick="selectGroup(1)" id="tab-1" class="flex-1 py-3 text-center text-gray-400 hover:bg-gray-50 transition-all">2ì¡°</button>
        <button onclick="selectGroup(2)" id="tab-2" class="flex-1 py-3 text-center text-gray-400 hover:bg-gray-50 transition-all">3ì¡°</button>
    </div>

    <div id="player-list" class="flex-1 overflow-y-auto p-3 space-y-3 pb-32 overscroll-contain">
        <div class="flex flex-col items-center justify-center h-64 text-gray-400">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-green-600 mb-4"></div>
            <p class="font-bold">ìŠ¤ì½”ì–´ ì¹´ë“œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>

    <nav class="bg-white border-t flex justify-around py-3 pb-8 sticky bottom-0 shadow-[0_-4px_15px_-3px_rgba(0,0,0,0.1)] z-50">
        <div class="text-center text-green-700 cursor-pointer transform scale-105 transition-transform"><span class="text-2xl block mb-1">âœï¸</span><span class="text-xs font-bold">ê¸°ë¡</span></div>
        <div class="text-center text-gray-300 cursor-pointer hover:text-gray-500 transition-colors" onclick="alert('ê²½ê¸° ì¢…ë£Œ í›„ ì œê³µë©ë‹ˆë‹¤')"><span class="text-2xl block mb-1">ğŸ†</span><span class="text-xs">ë­í‚¹</span></div>
        <div class="text-center text-gray-300 cursor-pointer hover:text-gray-500 transition-colors" onclick="alert('ê´€ë¦¬ì ì „ìš©ì…ë‹ˆë‹¤')"><span class="text-2xl block mb-1">âš™ï¸</span><span class="text-xs">ì„¤ì •</span></div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ========================================================
        // [ì„¤ì •] ì„ ìƒë‹˜ì˜ Firebase ì„¤ì •ê°’ (ê·¸ëŒ€ë¡œ ì‚¬ìš©)
        // ========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDBxfI5ufgfTKYGgLSeoQXwv2_MsAj_n-w",
            authDomain: "golf-score-c61ad.firebaseapp.com",
            projectId: "golf-score-c61ad",
            storageBucket: "golf-score-c61ad.firebasestorage.app",
            messagingSenderId: "266282417748",
            appId: "1:266282417748:web:d4c975ccb26c460d0bb7c1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ì½”ìŠ¤ ë°ì´í„°
        const COURSES = {
            hill: { name: "Hill Course", pars: [4, 4, 4, 3, 5, 4, 5, 3, 4, 4, 5, 3, 4, 4, 5, 4, 3, 4] },
            lake: { name: "Lake Course", pars: [4, 4, 3, 5, 4, 5, 4, 3, 4, 4, 5, 4, 4, 3, 4, 3, 5, 4] }
        };

        // ì „ì—­ ë³€ìˆ˜
        let currentHole = 1;
        let currentGroup = 0;
        let currentCourse = "hill";
        const matchId = "match_2025_05_20"; 
        let globalData = null;

        // DB ì—°ê²°
        const matchRef = doc(db, "matches", matchId);
        
        onSnapshot(matchRef, (docSnap) => {
            if (docSnap.exists()) {
                globalData = docSnap.data();
                if(globalData.course && globalData.course !== currentCourse) {
                    currentCourse = globalData.course;
                    document.getElementById('courseSelect').value = currentCourse;
                }
                renderUI();
            } else {
                createInitialData();
            }
        });

        // ì´ˆê¸° ë°ì´í„° ìƒì„± (ê°ì²´ êµ¬ì¡° ì‚¬ìš©)
        async function createInitialData() {
            const initData = {
                course: "hill",
                groups: {
                    "0": [
                        { name: "ê¹€íšŒì¥", hcp: 18, scores: Array(18).fill(0) },
                        { name: "ì´ì´ë¬´", hcp: 22, scores: Array(18).fill(0) },
                        { name: "ë°•í”„ë¡œ", hcp: 8, scores: Array(18).fill(0) },
                        { name: "ìµœì´ì‚¬", hcp: 15, scores: Array(18).fill(0) }
                    ],
                    "1": [
                        { name: "ê°•ëŒ€í‘œ", hcp: 10, scores: Array(18).fill(0) },
                        { name: "ì •ì „ë¬´", hcp: 14, scores: Array(18).fill(0) },
                        { name: "í•œë¶€ì¥", hcp: 25, scores: Array(18).fill(0) }
                    ],
                    "2": []
                }
            };
            try { await setDoc(matchRef, initData); } 
            catch (e) { console.error("ì´ˆê¸°í™” ì‹¤íŒ¨", e); }
        }

        // UI ë Œë”ë§ í•¨ìˆ˜
        window.renderUI = function() {
            if (!globalData) return;

            const parList = COURSES[currentCourse].pars;
            document.getElementById('currentHoleDisplay').innerText = `HOLE ${currentHole}`;
            document.getElementById('currentParDisplay').innerText = `Par ${parList[currentHole-1]}`;

            // íƒ­ í™œì„±í™” ìƒíƒœ
            [0, 1, 2].forEach(idx => {
                const btn = document.getElementById(`tab-${idx}`);
                if(idx === currentGroup) {
                    btn.className = "flex-1 py-3 text-center font-bold text-green-800 border-b-4 border-green-600 bg-green-50 transition-all";
                } else {
                    btn.className = "flex-1 py-3 text-center text-gray-400 hover:bg-gray-50 transition-all border-b border-gray-100";
                }
            });

            const listDiv = document.getElementById('player-list');
            listDiv.innerHTML = "";
            
            const players = globalData.groups[currentGroup.toString()];
            if(!players || players.length === 0) {
                listDiv.innerHTML = "<div class='flex flex-col items-center justify-center h-40 text-gray-400'><span class='text-4xl mb-2'>ğŸŒï¸</span><p>ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>";
                return;
            }

            players.forEach((player, pIndex) => {
                const score = player.scores[currentHole-1];
                const totalScore = player.scores.reduce((a,b)=>a+b, 0);
                
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-3 relative overflow-hidden";
                
                // ì ìˆ˜ë³„ ìƒ‰ìƒ ì²˜ë¦¬
                let scoreColor = "text-gray-800"; 
                if(score < 0) scoreColor = "text-blue-600";
                if(score > 0) scoreColor = "text-red-500";
                
                // ì ìˆ˜ í…ìŠ¤íŠ¸ ì²˜ë¦¬ (0ì€ Eë¡œ í‘œì‹œí•˜ê±°ë‚˜ ê·¸ëƒ¥ 0)
                let scoreText = score > 0 ? `+${score}` : `${score}`;
                if(score === 0) scoreText = "0"; // íŒŒ

                card.innerHTML = `
                    <div class="flex justify-between items-center mb-4 pl-1 pr-1">
                        <div class="flex items-center gap-3">
                            <div class="w-11 h-11 rounded-full bg-gray-100 flex items-center justify-center text-sm font-bold text-gray-600 border border-gray-200 shadow-inner">
                                ${player.name.slice(0,1)}
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg leading-none mb-1">${player.name}</h3>
                                <span class="text-xs text-white bg-gray-400 px-1.5 py-0.5 rounded-md font-medium">Hcp ${player.hcp}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-[10px] text-gray-400 uppercase font-bold tracking-wider block mb-0.5">Total Score</span>
                            <span class="font-black text-2xl px-2 py-0.5 rounded ${totalScore > 0 ? 'text-red-500' : (totalScore < 0 ? 'text-blue-600' : 'text-gray-800')}">
                                ${totalScore > 0 ? '+' : ''}${totalScore}
                            </span>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between bg-gray-50 rounded-xl p-1.5 border border-gray-200 shadow-inner">
                        <button onclick="updateScore(${pIndex}, ${score - 1})" 
                            class="w-14 h-12 flex items-center justify-center bg-white rounded-lg shadow-sm border border-gray-200 text-2xl font-bold text-gray-400 active:scale-95 active:bg-gray-100 active:text-blue-500 transition-all touch-manipulation">
                            ï¼
                        </button>
                        
                        <div class="flex-1 text-center font-black text-3xl ${scoreColor} tabular-nums">
                            ${scoreText}
                        </div>
                        
                        <button onclick="updateScore(${pIndex}, ${score + 1})" 
                            class="w-14 h-12 flex items-center justify-center bg-white rounded-lg shadow-sm border border-gray-200 text-2xl font-bold text-gray-400 active:scale-95 active:bg-gray-100 active:text-red-500 transition-all touch-manipulation">
                            ï¼‹
                        </button>
                    </div>
                `;
                listDiv.appendChild(card);
            });
        };

        // ì ìˆ˜ ì €ì¥ í•¨ìˆ˜ (ìƒíƒœ í‘œì‹œë“± ê¸°ëŠ¥ ì¶”ê°€)
        window.updateScore = async function(playerIndex, value) {
            if(!globalData) return;
            
            // 1. ì¦‰ì‹œ í™”ë©´ ë°˜ì˜ (ì†ë„ê° í–¥ìƒ)
            globalData.groups[currentGroup.toString()][playerIndex].scores[currentHole-1] = value;
            renderUI(); 
            
            // 2. ìƒíƒœ í‘œì‹œ: ì €ì¥ì¤‘ (ë…¸ë€ìƒ‰)
            const statusEl = document.getElementById('saveStatus');
            statusEl.innerText = "ì €ì¥ì¤‘..";
            statusEl.className = "text-xs font-bold px-2 py-1 rounded bg-yellow-400 text-yellow-900 opacity-100 scale-100 shadow-sm";

            try {
                // 3. ì‹¤ì œ DB ì €ì¥
                await updateDoc(matchRef, { groups: globalData.groups });
                
                // 4. ì €ì¥ ì™„ë£Œ (ì´ˆë¡ìƒ‰) -> 1ì´ˆ ë’¤ ì‚¬ë¼ì§
                statusEl.innerText = "ì €ì¥ë¨ âœ…";
                statusEl.className = "text-xs font-bold px-2 py-1 rounded bg-green-500 text-white opacity-100 scale-100 shadow-sm transition-all";
                setTimeout(() => {
                    statusEl.className = "text-xs font-bold px-2 py-1 rounded opacity-0 scale-90 transition-all duration-500";
                }, 1000);

            } catch(e) {
                console.error("ì €ì¥ ì‹¤íŒ¨", e);
                statusEl.innerText = "ì˜¤ë¥˜! ğŸš«";
                statusEl.className = "text-xs font-bold px-2 py-1 rounded bg-red-600 text-white opacity-100 animate-pulse";
                alert("ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”. ì ìˆ˜ê°€ ì„œë²„ì— ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }
        };

        window.changeHole = function(direction) {
            const nextHole = currentHole + direction;
            if(nextHole >= 1 && nextHole <= 18) {
                currentHole = nextHole;
                renderUI();
                window.scrollTo(0,0);
            }
        };

        window.selectGroup = function(groupIndex) {
            currentGroup = groupIndex;
            renderUI();
        };

        window.changeCourse = async function() {
            const selected = document.getElementById('courseSelect').value;
            currentCourse = selected;
            renderUI();
            await updateDoc(matchRef, { course: selected });
        }
    </script>
</body>
</html>
