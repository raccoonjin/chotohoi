<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¡±íƒ„ ê³¨í”„ ëª¨ì„</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="ë¡±íƒ„ê³¨í”„">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1202/1202125.png">
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    
    <style>
        body { touch-action: manipulation; -webkit-tap-highlight-color: transparent; user-select: none; }
        .score-btn:active { transform: scale(0.95); }
        .bg-grass { background-color: #f0fdf4; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 300ms; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .score-table th, .score-table td { text-align: center; border: 1px solid #e5e7eb; padding: 4px; font-size: 12px; white-space: nowrap; }
        .score-table .hole-num { background-color: #f3f4f6; font-weight: bold; }
        .score-table .out-in-sum { background-color: #d1fae5; font-weight: bold; }
    </style>
</head>
<body class="bg-grass h-screen flex flex-col font-sans overflow-hidden">

    <header class="bg-green-800 text-white p-4 pb-2 shadow-lg sticky top-0 z-50 pt-safe-top">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-2">
                <div class="flex flex-col items-start">
                    <span id="headerDate" class="text-[10px] text-green-200 font-medium">Loading...</span>
                    <div class="bg-green-900 px-2 py-0.5 rounded text-xs font-bold border border-green-600 shadow-sm" id="headerCourseName">
                        -
                    </div>
                </div>
                <div onclick="logout()" class="bg-black/30 px-2 py-1 rounded text-xs flex items-center gap-1 cursor-pointer">
                    <span class="text-gray-300 text-[10px]">User:</span>
                    <span id="currentUserDisplay" class="font-bold text-yellow-300">GUEST</span>
                </div>
                <span id="saveStatus" class="text-xs font-bold px-2 py-1 rounded opacity-0 transition-all transform scale-90">ëŒ€ê¸°</span>
            </div>
            <span class="text-xs bg-red-600 text-white font-bold px-2 py-1 rounded animate-pulse shadow-md">LIVE ğŸ”´</span>
        </div>
        
        <div class="flex justify-between items-center bg-green-700 rounded-xl p-2 shadow-inner border border-green-600">
            <button onclick="changeHole(-1)" class="w-12 h-10 flex items-center justify-center font-bold text-2xl active:bg-green-800 rounded-lg text-green-100">â—€</button>
            <div class="text-center">
                <span class="text-2xl font-black block tracking-widest leading-none drop-shadow-md" id="currentHoleDisplay">HOLE 1</span>
                <span class="text-sm text-green-200 font-medium" id="currentParDisplay">Par 4</span>
            </div>
            <button onclick="changeHole(1)" class="w-12 h-10 flex items-center justify-center font-bold text-2xl active:bg-green-800 rounded-lg text-green-100">â–¶</button>
        </div>
    </header>

    <div id="tabsContainer" class="flex bg-white border-b border-green-100 shadow-sm z-40 overflow-x-auto hide-scroll whitespace-nowrap px-1">
        <div class="flex-1 py-3 text-center text-gray-400 text-sm">ê²½ê¸° ë¡œë”©ì¤‘...</div>
    </div>

    <div id="player-list" class="flex-1 overflow-y-auto p-3 space-y-3 pb-32 overscroll-contain">
        <div class="flex flex-col items-center justify-center h-64 text-gray-400">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-green-600 mb-4"></div>
            <p class="font-bold">ë°ì´í„° ì—°ê²° ì¤‘...</p>
        </div>
    </div>

    <nav class="bg-white border-t flex justify-around py-3 pb-8 sticky bottom-0 shadow-[0_-4px_15px_-3px_rgba(0,0,0,0.1)] z-50">
        <div class="text-center text-green-700 cursor-pointer transform scale-105" onclick="closeAllModals()"><span class="text-2xl block mb-1">âœï¸</span><span class="text-xs font-bold">ê¸°ë¡</span></div>
        <div class="text-center text-gray-500 cursor-pointer hover:text-green-700 transition-colors" onclick="openScorecard()"><span class="text-2xl block mb-1">ğŸ†</span><span class="text-xs font-bold">ìŠ¤ì½”ì–´ì¹´ë“œ</span></div>
        <div class="text-center text-gray-500 cursor-pointer hover:text-green-700 transition-colors" onclick="openSettingsMain()"><span class="text-2xl block mb-1">âš™ï¸</span><span class="text-xs font-bold">ì„¤ì •</span></div>
    </nav>

    <div id="loginModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[90] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-2 text-center">ğŸ‘‹ ëˆ„êµ¬ì„¸ìš”?</h2>
            <p class="text-sm text-gray-500 mb-6 text-center">ë³¸ì¸ì˜ ì´ë¦„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.<br>ì„ íƒí•œ íšŒì›ì˜ ì¡°ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            
            <select id="loginSelect" class="w-full p-4 text-lg border-2 border-green-500 rounded-xl mb-4 font-bold bg-green-50">
                <option value="">ì´ë¦„ ì„ íƒ</option>
            </select>
            
            <button onclick="performLogin()" class="w-full py-4 rounded-xl bg-green-600 font-bold text-white text-lg shadow-lg active:bg-green-700">
                ì…ì¥í•˜ê¸°
            </button>
            <div class="mt-4 text-center">
                <button onclick="guestLogin()" class="text-xs text-gray-400 underline">ê´€ë¦¬ì/êµ¬ê²½ê¾¼ìœ¼ë¡œ ì…ì¥</button>
            </div>
        </div>
    </div>

    <div id="scorecardModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] hidden flex items-center justify-center p-2">
        <div class="bg-white w-full max-w-4xl rounded-2xl p-2 shadow-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-2 border-b">
                <h2 class="text-lg font-bold text-gray-800">ğŸ† 18í™€ ìŠ¤ì½”ì–´ì¹´ë“œ</h2>
                <button onclick="document.getElementById('scorecardModal').classList.add('hidden')" class="text-gray-400 text-2xl">&times;</button>
            </div>
            <div class="flex-1 overflow-auto p-1" id="scorecardContent">
                </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-2 transition-opacity duration-300">
        <div class="bg-white w-full max-w-lg rounded-2xl p-4 shadow-2xl max-h-[90vh] flex flex-col h-full overflow-hidden">
            <div class="flex justify-between items-center mb-2 border-b pb-3 shrink-0">
                <div class="flex items-center gap-2">
                    <button id="btnBackToMain" onclick="showView('main')" class="hidden text-gray-500 text-lg font-bold">â—€</button>
                    <h2 id="settingsTitle" class="text-xl font-bold text-gray-800">ì„¤ì •</h2>
                </div>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            
            <div id="viewMain" class="flex flex-col gap-4 py-10 px-2">
                <button onclick="openMemberReg()" class="flex flex-col items-center justify-center p-8 bg-blue-50 border-2 border-blue-100 rounded-2xl active:bg-blue-100">
                    <span class="text-4xl mb-2">ğŸ‘¤</span>
                    <span class="text-xl font-bold text-blue-800">íšŒì› ê´€ë¦¬</span>
                    <span class="text-sm text-gray-500 mt-1">ì´ë¦„ ë“±ë¡ / ìˆ˜ì • / ì‚­ì œ</span>
                </button>
                <button onclick="openMatchSetup()" class="flex flex-col items-center justify-center p-8 bg-green-50 border-2 border-green-100 rounded-2xl active:bg-green-100">
                    <span class="text-4xl mb-2">â›³</span>
                    <span class="text-xl font-bold text-green-800">ê²½ê¸° ì„¤ì •</span>
                    <span class="text-sm text-gray-500 mt-1">ì¡° í¸ì„± / ì½”ìŠ¤ ë³€ê²½</span>
                </button>
            </div>

            <div id="viewMemberReg" class="hidden flex-1 flex flex-col overflow-hidden">
                <div class="bg-gray-50 p-3 rounded-xl border border-gray-200 mb-4 shrink-0">
                    <div class="flex gap-2">
                        <input type="text" id="regName" placeholder="ì´ë¦„" class="flex-[2] rounded-lg border-gray-300 text-sm">
                        <input type="number" id="regHcp" placeholder="í•¸ë””" class="flex-1 rounded-lg border-gray-300 text-sm">
                        <button onclick="addMemberToPool()" class="bg-blue-600 text-white px-4 rounded-lg font-bold">+</button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto space-y-2 px-1 pb-4" id="regListContainer"></div>
                <button onclick="saveMemberPool()" class="mt-2 w-full py-3 rounded-xl bg-blue-600 font-bold text-white shadow-lg shrink-0">ì €ì¥</button>
            </div>

            <div id="viewMatchSetup" class="hidden flex-1 flex flex-col overflow-hidden">
                <div class="space-y-4 flex-1 overflow-y-auto px-1 pb-4">
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <input type="date" id="matchDateInput" class="w-full rounded-lg border-gray-300 text-sm font-bold mb-3">
                        <div class="flex gap-2">
                            <button onclick="setTempCourse('hill')" id="btn-hill" class="flex-1 py-2 rounded-lg border font-bold text-sm">HILL</button>
                            <button onclick="setTempCourse('lake')" id="btn-lake" class="flex-1 py-2 rounded-lg border font-bold text-sm">LAKE</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2 text-sm">ì°¸ì„ì ì¡° ë°°ì •</h3>
                        <div id="matchListContainer" class="space-y-2"></div>
                    </div>
                </div>
                <button onclick="saveMatchSetup()" class="mt-2 w-full py-3 rounded-xl bg-green-600 font-bold text-white shadow-lg shrink-0">ì ìš©</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDBxfI5ufgfTKYGgLSeoQXwv2_MsAj_n-w",
            authDomain: "golf-score-c61ad.firebaseapp.com",
            projectId: "golf-score-c61ad",
            storageBucket: "golf-score-c61ad.firebasestorage.app",
            messagingSenderId: "266282417748",
            appId: "1:266282417748:web:d4c975ccb26c460d0bb7c1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const COURSES = {
            hill: { name: "HILL ì½”ìŠ¤", pars: [4, 4, 4, 3, 5, 4, 5, 3, 4, 4, 5, 3, 4, 4, 5, 4, 3, 4] },
            lake: { name: "LAKE ì½”ìŠ¤", pars: [4, 4, 3, 5, 4, 5, 4, 3, 4, 4, 5, 4, 4, 3, 4, 3, 5, 4] }
        };

        let currentHole = 1;
        let currentGroup = 0;
        let currentCourse = "hill";
        const matchId = "match_v4_scorecard"; // V4 ID
        
        let globalData = null;
        let currentUser = localStorage.getItem("golf_user_name") || null; // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì´ë¦„

        // ì„¤ì •ì°½ ì„ì‹œë³€ìˆ˜
        let tempMemberPool = []; 
        let tempMatchMembers = [];
        let tempCourse = "hill";
        let tempDate = "";

        const matchRef = doc(db, "matches", matchId);
        
        // 1. ë°ì´í„° ë¡œë“œ ë° ì´ˆê¸°í™”
        onSnapshot(matchRef, (docSnap) => {
            if (docSnap.exists()) {
                globalData = docSnap.data();
                syncHeaderInfo();
                renderTabs();
                renderUI();
                checkLogin(); // ë°ì´í„° ë¡œë“œ í›„ ë¡œê·¸ì¸ ì²´í¬
            } else {
                createInitialData();
            }
        });

        async function createInitialData() {
            const today = new Date().toISOString().split('T')[0];
            await setDoc(matchRef, { matchDate: today, course: "hill", memberPool: [], groups: {} });
        }

        function syncHeaderInfo() {
            if(globalData.course && globalData.course !== currentCourse) {
                currentCourse = globalData.course;
            }
            document.getElementById('headerCourseName').innerText = COURSES[currentCourse].name;
            document.getElementById('headerDate').innerText = globalData.matchDate || "ë‚ ì§œ ë¯¸ì •";
            
            // ë¡œê·¸ì¸ ìœ ì € í‘œì‹œ
            const userDisplay = currentUser || "GUEST";
            document.getElementById('currentUserDisplay').innerText = userDisplay;
        }

        // ============================
        //  ğŸ” ë¡œê·¸ì¸ (ë³¸ì¸ ì¸ì¦) ë¡œì§
        // ============================
        function checkLogin() {
            if(!currentUser && globalData.memberPool && globalData.memberPool.length > 0) {
                // ë¡œê·¸ì¸ ì•ˆ ë˜ì–´ìˆìœ¼ë©´ ëª¨ë‹¬ ë„ì›€
                const select = document.getElementById('loginSelect');
                select.innerHTML = '<option value="">ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                globalData.memberPool.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.name;
                    opt.innerText = m.name;
                    select.appendChild(opt);
                });
                document.getElementById('loginModal').classList.remove('hidden');
            }
        }

        window.performLogin = function() {
            const val = document.getElementById('loginSelect').value;
            if(!val) return alert("ì´ë¦„ì„ ì„ íƒí•´ì£¼ì„¸ìš”");
            currentUser = val;
            localStorage.setItem("golf_user_name", val);
            document.getElementById('loginModal').classList.add('hidden');
            syncHeaderInfo();
            renderUI(); // ê¶Œí•œ ë°˜ì˜í•´ì„œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        }

        window.guestLogin = function() {
            if(confirm("ê¸°ë¡ ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•œ 'êµ¬ê²½ê¾¼' ëª¨ë“œë¡œ ì…ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì„¤ì •ì€ ê°€ëŠ¥)")) {
                currentUser = "GUEST";
                document.getElementById('loginModal').classList.add('hidden');
                syncHeaderInfo();
                renderUI();
            }
        }

        window.logout = function() {
            if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                currentUser = null;
                localStorage.removeItem("golf_user_name");
                location.reload();
            }
        }

        // í˜„ì¬ ìœ ì €ê°€ ì´ ì¡°(currentGroup)ë¥¼ ìˆ˜ì •í•  ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸
        function canEditCurrentGroup() {
            if(!currentUser || currentUser === "GUEST") return false;
            if(!globalData.groups) return false;
            
            // í˜„ì¬ ë³´ê³ ìˆëŠ” ì¡°(currentGroup)ì˜ ë©¤ë²„ ë¦¬ìŠ¤íŠ¸
            const playersInGroup = globalData.groups[currentGroup.toString()];
            if(!playersInGroup) return false;

            // ê·¸ ë¦¬ìŠ¤íŠ¸ ì•ˆì— ë‚´ ì´ë¦„ì´ ìˆëŠ”ì§€ í™•ì¸
            return playersInGroup.some(p => p.name === currentUser);
        }

        // ============================
        //  UI ë Œë”ë§ (ê¶Œí•œ ì ìš©)
        // ============================
        window.renderTabs = function() {
            const container = document.getElementById('tabsContainer');
            if(!globalData || !globalData.groups) return;
            const groupKeys = Object.keys(globalData.groups).sort((a,b) => parseInt(a) - parseInt(b));
            
            if(groupKeys.length === 0) {
                container.innerHTML = `<div class="flex-1 py-3 text-center text-gray-400 text-sm">ì„¤ì •ì—ì„œ ì¡°ë¥¼ í¸ì„±í•´ì£¼ì„¸ìš”</div>`;
                return;
            }
            container.innerHTML = "";
            groupKeys.forEach(gid => {
                const groupNum = parseInt(gid) + 1;
                const btn = document.createElement('button');
                btn.id = `tab-${gid}`;
                btn.onclick = () => selectGroup(parseInt(gid));
                btn.textContent = `${groupNum}ì¡°`;
                btn.className = "min-w-[70px] px-4 py-3 text-center transition-all border-b-4 border-transparent text-gray-400 hover:bg-gray-50 flex-shrink-0";
                container.appendChild(btn);
            });
            if(!globalData.groups[currentGroup]) {
                currentGroup = groupKeys.length > 0 ? parseInt(groupKeys[0]) : 0;
            }
        };

        window.renderUI = function() {
            if (!globalData) return;
            const parList = COURSES[currentCourse].pars;
            
            document.getElementById('currentHoleDisplay').innerText = `HOLE ${currentHole}`;
            document.getElementById('currentParDisplay').innerText = `Par ${parList[currentHole-1]}`;

            // íƒ­ ìŠ¤íƒ€ì¼
            Object.keys(globalData.groups || {}).forEach(gid => {
                const btn = document.getElementById(`tab-${gid}`);
                if(btn) {
                    if(parseInt(gid) === currentGroup) {
                        btn.className = "min-w-[70px] px-4 py-3 text-center font-bold text-green-800 border-b-4 border-green-600 bg-green-50 transition-all flex-shrink-0";
                        btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    } else {
                        btn.className = "min-w-[70px] px-4 py-3 text-center text-gray-400 hover:bg-gray-50 transition-all border-b border-gray-100 flex-shrink-0";
                    }
                }
            });

            const listDiv = document.getElementById('player-list');
            listDiv.innerHTML = "";
            const players = globalData.groups[currentGroup.toString()];
            
            // â˜… ê¶Œí•œ ì²´í¬: ë‚´ ì¡°ê°€ ì•„ë‹ˆë©´ ìˆ˜ì • ë¶ˆê°€
            const isEditable = canEditCurrentGroup();

            if(!players || players.length === 0) {
                listDiv.innerHTML = `<div class='flex flex-col items-center justify-center h-64 text-gray-400'><span class='text-4xl mb-2'>â›³</span><p class="font-bold">ì„ ìˆ˜ ì—†ìŒ</p></div>`;
                return;
            }

            // ê¶Œí•œ ì•ˆë‚´ ë©”ì‹œì§€
            if(!isEditable) {
                const msg = document.createElement('div');
                msg.className = "text-center text-xs text-red-400 bg-red-50 py-2 rounded mb-2 border border-red-100";
                msg.innerHTML = "ğŸ”’ <b>ë³´ê¸° ì „ìš©</b> (ë³¸ì¸ì´ ì†í•œ ì¡°ë§Œ ê¸°ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤)";
                listDiv.appendChild(msg);
            }

            players.forEach((player, pIndex) => {
                const score = player.scores[currentHole-1];
                const totalScore = player.scores.reduce((a,b)=>a+b, 0);
                
                let scoreColor = "text-gray-800"; 
                if(score < 0) scoreColor = "text-blue-600";
                if(score > 0) scoreColor = "text-red-500";
                let scoreText = score > 0 ? `+${score}` : `${score}`;
                if(score === 0) scoreText = "0";

                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-3 relative overflow-hidden";
                
                // ì…ë ¥ ë²„íŠ¼ (ê¶Œí•œ ì—†ìœ¼ë©´ ë¹„í™œì„±í™”/ìˆ¨ê¹€)
                let inputHtml = "";
                if(isEditable) {
                    inputHtml = `
                    <div class="flex items-center justify-between bg-gray-50 rounded-xl p-1.5 border border-gray-200 shadow-inner">
                        <button onclick="updateScore(${pIndex}, ${score - 1})" class="w-14 h-12 flex items-center justify-center bg-white rounded-lg shadow-sm border border-gray-200 text-2xl font-bold text-gray-400 active:scale-95 active:bg-gray-100 active:text-blue-500 transition-all">ï¼</button>
                        <div class="flex-1 text-center font-black text-3xl ${scoreColor} tabular-nums">${scoreText}</div>
                        <button onclick="updateScore(${pIndex}, ${score + 1})" class="w-14 h-12 flex items-center justify-center bg-white rounded-lg shadow-sm border border-gray-200 text-2xl font-bold text-gray-400 active:scale-95 active:bg-gray-100 active:text-red-500 transition-all">ï¼‹</button>
                    </div>`;
                } else {
                    // ê¶Œí•œ ì—†ì„ ë• ì ìˆ˜ë§Œ í¬ê²Œ í‘œì‹œ
                    inputHtml = `
                    <div class="flex items-center justify-center bg-gray-50 rounded-xl p-3 border border-gray-200">
                        <div class="font-black text-3xl ${scoreColor} tabular-nums">${scoreText}</div>
                    </div>`;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-center mb-4 pl-1 pr-1">
                        <div class="flex items-center gap-3">
                            <div class="w-11 h-11 rounded-full bg-gray-100 flex items-center justify-center text-sm font-bold text-gray-600 border border-gray-200 shadow-inner">
                                ${player.name.slice(0,1)}
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg leading-none mb-1">${player.name}</h3>
                                <span class="text-xs text-white bg-gray-400 px-1.5 py-0.5 rounded-md font-medium">Hcp ${player.hcp}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-[10px] text-gray-400 uppercase font-bold tracking-wider block mb-0.5">Total</span>
                            <span class="font-black text-2xl px-2 py-0.5 rounded ${totalScore > 0 ? 'text-red-500' : (totalScore < 0 ? 'text-blue-600' : 'text-gray-800')}">
                                ${totalScore > 0 ? '+' : ''}${totalScore}
                            </span>
                        </div>
                    </div>
                    ${inputHtml}
                `;
                listDiv.appendChild(card);
            });
        };

        window.updateScore = async function(playerIndex, value) {
            // ë”ë¸” ì²´í¬ (í•´í‚¹ ë°©ì§€ìš©)
            if(!canEditCurrentGroup()) return alert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");

            globalData.groups[currentGroup.toString()][playerIndex].scores[currentHole-1] = value;
            renderUI(); 
            const statusEl = document.getElementById('saveStatus');
            statusEl.innerText = "ì €ì¥ì¤‘..";
            statusEl.className = "text-xs font-bold px-2 py-1 rounded bg-yellow-400 text-yellow-900 opacity-100 scale-100 shadow-sm";
            try {
                await updateDoc(matchRef, { groups: globalData.groups });
                statusEl.innerText = "ì €ì¥ë¨ âœ…";
                statusEl.className = "text-xs font-bold px-2 py-1 rounded bg-green-500 text-white opacity-100 scale-100 shadow-sm transition-all";
                setTimeout(() => { statusEl.className = "text-xs font-bold px-2 py-1 rounded opacity-0 scale-90 transition-all duration-500"; }, 1000);
            } catch(e) { statusEl.innerText = "ì˜¤ë¥˜! ğŸš«"; }
        };

        window.changeHole = function(d) {
            const next = currentHole + d;
            if(next >= 1 && next <= 18) { currentHole = next; renderUI(); window.scrollTo(0,0); }
        };
        window.selectGroup = function(g) { currentGroup = g; renderUI(); };

        // ============================
        // ğŸ† ìŠ¤ì½”ì–´ì¹´ë“œ (18í™€ ë³´ê¸°)
        // ============================
        window.openScorecard = function() {
            if(!globalData) return;
            const players = globalData.groups[currentGroup.toString()] || [];
            const container = document.getElementById('scorecardContent');
            const pars = COURSES[currentCourse].pars;

            let html = `<table class="w-full score-table"><thead><tr><th class="bg-gray-100 sticky left-0 z-10">ì´ë¦„</th>`;
            
            // í—¤ë” (1~9, OUT, 10~18, IN, TOT)
            for(let i=1; i<=9; i++) html += `<th class="hole-num">${i}</th>`;
            html += `<th class="bg-green-100">OUT</th>`;
            for(let i=10; i<=18; i++) html += `<th class="hole-num">${i}</th>`;
            html += `<th class="bg-green-100">IN</th><th class="bg-gray-200">TOT</th></tr></thead><tbody>`;

            // íŒŒ ì •ë³´
            html += `<tr><td class="bg-gray-50 sticky left-0 font-bold">PAR</td>`;
            let outPar = 0, inPar = 0;
            pars.forEach((p, i) => {
                html += `<td>${p}</td>`;
                if(i<9) outPar += p; else inPar += p;
                if(i===8) html += `<td class="out-in-sum">${outPar}</td>`;
                if(i===17) html += `<td class="out-in-sum">${inPar}</td><td class="bg-gray-200 font-bold">${outPar+inPar}</td>`;
            });
            html += `</tr>`;

            // ì„ ìˆ˜ë³„ ìŠ¤ì½”ì–´
            players.forEach(p => {
                html += `<tr><td class="bg-white sticky left-0 font-bold border-r">${p.name}</td>`;
                let outSum = 0, inSum = 0;
                p.scores.forEach((s, i) => {
                    const absScore = pars[i] + s; // ì‹¤ì œ íƒ€ìˆ˜
                    // ìŠ¤ì½”ì–´ ìƒ‰ìƒ
                    let style = "";
                    if(s < 0) style = "text-blue-600 font-bold";
                    if(s > 0) style = "text-red-500";
                    
                    html += `<td class="${style}">${absScore}</td>`;
                    
                    if(i<9) outSum += absScore; else inSum += absScore;
                    if(i===8) html += `<td class="bg-green-50 font-bold">${outSum}</td>`;
                    if(i===17) html += `<td class="bg-green-50 font-bold">${inSum}</td><td class="bg-gray-100 font-bold text-lg">${outSum+inSum}</td>`;
                });
                html += `</tr>`;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
            document.getElementById('scorecardModal').classList.remove('hidden');
        };

        window.closeAllModals = function() {
            document.getElementById('scorecardModal').classList.add('hidden');
            document.getElementById('settingsModal').classList.add('hidden');
        };

        // ============================
        //  âš™ï¸ ì„¤ì • (ì´ì „ê³¼ ë™ì¼)
        // ============================
        window.openSettingsMain = function() {
            if(!globalData) return alert("ë¡œë”©ì¤‘...");
            showView('main');
            document.getElementById('settingsModal').classList.remove('hidden');
        };
        window.closeSettings = function() { document.getElementById('settingsModal').classList.add('hidden'); };
        window.showView = function(viewName) {
            document.getElementById('viewMain').classList.add('hidden');
            document.getElementById('viewMemberReg').classList.add('hidden');
            document.getElementById('viewMatchSetup').classList.add('hidden');
            document.getElementById('btnBackToMain').classList.add('hidden');
            if(viewName === 'main') {
                document.getElementById('viewMain').classList.remove('hidden');
                document.getElementById('settingsTitle').innerText = "ì„¤ì •";
            } else if(viewName === 'member') {
                document.getElementById('viewMemberReg').classList.remove('hidden');
                document.getElementById('settingsTitle').innerText = "íšŒì› ê´€ë¦¬";
                document.getElementById('btnBackToMain').classList.remove('hidden');
            } else if(viewName === 'match') {
                document.getElementById('viewMatchSetup').classList.remove('hidden');
                document.getElementById('settingsTitle').innerText = "ê²½ê¸° ì„¤ì •";
                document.getElementById('btnBackToMain').classList.remove('hidden');
            }
        };

        // íšŒì›ë“±ë¡
        window.openMemberReg = function() {
            tempMemberPool = JSON.parse(JSON.stringify(globalData.memberPool || []));
            renderMemberPool_RegMode();
            showView('member');
        };
        window.renderMemberPool_RegMode = function() {
            const container = document.getElementById('regListContainer');
            container.innerHTML = "";
            tempMemberPool.forEach((member, idx) => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-white p-3 rounded-lg border border-gray-200";
                div.innerHTML = `<div><span class="font-bold">${member.name}</span> <span class="text-xs text-gray-400">Hcp ${member.hcp}</span></div><button onclick="deleteMemberFromPool(${idx})" class="text-red-400 font-bold px-2">ì‚­ì œ</button>`;
                container.appendChild(div);
            });
        };
        window.addMemberToPool = function() {
            const name = document.getElementById('regName').value.trim();
            const hcp = parseInt(document.getElementById('regHcp').value) || 0;
            if(!name) return alert("ì´ë¦„ ì…ë ¥");
            if(tempMemberPool.some(m=>m.name===name)) return alert("ì´ë¯¸ ì¡´ì¬");
            tempMemberPool.unshift({name, hcp});
            document.getElementById('regName').value = "";
            renderMemberPool_RegMode();
        };
        window.deleteMemberFromPool = function(idx) {
            if(confirm("ì‚­ì œ?")) { tempMemberPool.splice(idx, 1); renderMemberPool_RegMode(); }
        };
        window.saveMemberPool = async function() {
            if(!confirm("ì €ì¥?")) return;
            try { await updateDoc(matchRef, { memberPool: tempMemberPool }); alert("ì €ì¥ë¨"); showView('main'); } catch(e){ alert("ì‹¤íŒ¨"); }
        };

        // ê²½ê¸°ì„¤ì •
        window.openMatchSetup = function() {
            tempCourse = globalData.course || "hill";
            tempDate = globalData.matchDate || new Date().toISOString().split('T')[0];
            setTempCourse(tempCourse);
            document.getElementById('matchDateInput').value = tempDate;

            tempMatchMembers = [];
            const pool = globalData.memberPool || [];
            pool.forEach(member => {
                let assigned = null;
                if(globalData.groups) {
                    Object.keys(globalData.groups).forEach(gid => {
                        if(globalData.groups[gid].some(p => p.name === member.name)) assigned = parseInt(gid) + 1;
                    });
                }
                tempMatchMembers.push({ ...member, assignedGroup: assigned });
            });
            renderMatchList();
            showView('match');
        };
        window.setTempCourse = function(c) {
            tempCourse = c;
            document.getElementById('btn-hill').className = c==='hill' ? "flex-1 py-2 rounded-lg border-2 border-green-600 bg-green-50 text-green-700 font-bold text-sm shadow-sm" : "flex-1 py-2 rounded-lg border border-gray-200 text-gray-400 font-medium text-sm";
            document.getElementById('btn-lake').className = c==='lake' ? "flex-1 py-2 rounded-lg border-2 border-blue-600 bg-blue-50 text-blue-700 font-bold text-sm shadow-sm" : "flex-1 py-2 rounded-lg border border-gray-200 text-gray-400 font-medium text-sm";
        };
        window.renderMatchList = function() {
            const container = document.getElementById('matchListContainer');
            container.innerHTML = "";
            tempMatchMembers.forEach((member, index) => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between bg-white p-3 rounded-xl border border-gray-200 shadow-sm";
                let grpNum = member.assignedGroup || 0;
                let grpText = grpNum > 0 ? `${grpNum}ì¡°` : "ë¯¸ì°¸ì„";
                let grpColor = grpNum > 0 ? "text-green-700 font-bold" : "text-gray-400";
                div.innerHTML = `
                    <div class="flex flex-col"><span class="font-bold text-gray-800">${member.name}</span><span class="text-xs text-gray-400">Hcp ${member.hcp}</span></div>
                    <div class="flex items-center border rounded-lg bg-white overflow-hidden">
                        <button onclick="changeGroupInMatch(${index}, -1)" class="px-3 py-2 bg-gray-50 text-gray-500 hover:bg-gray-100 border-r">ï¼</button>
                        <span class="w-16 text-center text-sm ${grpColor}">${grpText}</span>
                        <button onclick="changeGroupInMatch(${index}, 1)" class="px-3 py-2 bg-gray-50 text-green-600 hover:bg-green-50 border-l">ï¼‹</button>
                    </div>`;
                container.appendChild(div);
            });
        };
        window.changeGroupInMatch = function(idx, d) {
            let n = (tempMatchMembers[idx].assignedGroup || 0) + d;
            if(n<0) n=0;
            tempMatchMembers[idx].assignedGroup = n===0?null:n;
            renderMatchList();
        };
        window.saveMatchSetup = async function() {
            if(!confirm("ì ìš©?")) return;
            tempDate = document.getElementById('matchDateInput').value;
            const newGroups = {};
            const oldScoresMap = {};
            if(globalData.groups) Object.values(globalData.groups).forEach(g => g.forEach(p => oldScoresMap[p.name] = p.scores));
            
            tempMatchMembers.forEach(m => {
                if(m.assignedGroup > 0) {
                    const gid = (m.assignedGroup - 1).toString();
                    if(!newGroups[gid]) newGroups[gid] = [];
                    const savedScores = oldScoresMap[m.name] || Array(18).fill(0);
                    newGroups[gid].push({ name: m.name, hcp: m.hcp, scores: savedScores });
                }
            });
            try {
                await updateDoc(matchRef, { matchDate: tempDate, course: tempCourse, groups: newGroups });
                location.reload(); // ê¹”ë”í•˜ê²Œ ìƒˆë¡œê³ ì¹¨
            } catch(e) { alert("ì‹¤íŒ¨"); }
        };
    </script>
</body>
</html>
